#### C-5. マルチリポジトリ協調タスク
- **課題**: 現状は `--repo` で単一リポジトリのみを実行対象にしており、cross-repo依存タスクを同一セッションで協調実行できない。
- **提案内容**: `.yamibaito/repos.yaml`（`repo_id`, `path`, `depends_on_repo`）と `yb start/dispatch --repo-set <file>` を追加し、`tasks/*.yaml` に `target_repo` を持たせて repo 間依存を解決しながら配車する。
- **根拠**:
  - `bin/yb` の使用法と分岐は単数 `--repo <path>` 前提（`bin/yb:11-20`, `bin/yb:28-67`）。
  - `scripts/yb_start.sh` は単一 `repo_root` 変数で `queue_dir` を1本だけ作成（`scripts/yb_start.sh:7`, `scripts/yb_start.sh:13-15`, `scripts/yb_start.sh:129-131`）。
  - `scripts/yb_dispatch.sh` も worker 起動時に単一 `--repo "{repo_root}"` を渡す実装（`scripts/yb_dispatch.sh:91-94`）。
  - ワーカー環境変数も `YB_REPO_ROOT` 単数で注入される（`scripts/yb_start.sh:325`）。
- **期待効果**: マイクロサービス横断実装を1セッションで連結でき、repo切替や依存待ちの手動調整を削減できる。
- **security**:
  - 認可主体: dispatcher は `repos.yaml` の read のみ、worker は `target_repo` に割当済み worktree のみ read/write、director のみ `--repo-set` 更新を許可。
  - 入力検証: `repo_id` は `repos.yaml` の allowlist 一致必須、`path` は `realpath` で正規化し `..`/symlink 脱出/相対パスを拒否。
  - 秘密情報保管: repo ごとの token は GitHub Secrets またはローカル環境変数で注入し、`repos.yaml`/task YAML へ平文保存しない。
- **failure policy**:
  - retry/backoff/timeout: repo 解決と dispatch API は最大 3 回再試行、指数 backoff（2s/4s/8s, jitter 20%）、1 回の dispatch timeout は 60s。
  - circuit break: 同一 `repo_id` の dispatch 失敗が 10 分で 5 回到達したら 15 分オープンし、その repo への新規割当を停止。
  - 手動介入条件: circuit open が 2 連続、または依存待ち 30 分超のタスクが発生した場合は operator が `repos.yaml` と依存定義を確認して解除。
- **observability**:
  - 構造化ログキー: `event`, `cmd_id`, `task_id`, `repo_id`, `target_repo`, `attempt`, `elapsed_ms`, `result`, `error_code`。
  - 主要メトリクス: `yb_repo_dispatch_success_total`, `yb_repo_dispatch_failure_total`, `yb_repo_dispatch_latency_ms`, `yb_repo_dependency_wait_seconds`。
  - トレース/相関ID: `cmd_id:task_id` から `correlation_id` を生成し、dispatcher→worker へ `YB_CORRELATION_ID` として伝播。
- **test strategy**:
  - 正常系（2 repo 依存の自動配車）、異常系（不正 `repo_id`/`path` 脱出/依存欠損の拒否）、回帰（単一 repo 既存フロー維持）を unit/integration/e2e で分担検証。
- **優先度**: High

#### C-6. CI/CD パイプライン連携
- **課題**: `git-gtr` によるローカル worktree 運用はあるが、approve 後に CI で自動検証・マージ・デプロイする経路がない。
- **提案内容**: `.github/workflows/yb-quality-gate.yml` を追加し、`queue/reports/*_report.yaml` の `review_result: approve` を条件にテスト・品質ゲート・自動マージ判定を実行し、保護ブランチ/デプロイジョブに接続する。
- **根拠**:
  - `.github/` が存在せず GitHub Actions 定義ファイルがない（`.github`: `ls` で `No such file or directory`）。
  - `bin/yb` には `ci`/`deploy` 系サブコマンドがなく `start/dispatch/collect/worktree` 中心（`bin/yb:11-21`, `bin/yb:28-68`）。
  - `scripts/yb_start.sh`・`scripts/yb_worktree_list.sh`・`scripts/yb_restart.sh` は `gtr new/list/rm` などローカル worktree 操作が主（`scripts/yb_start.sh:90-97`, `scripts/yb_worktree_list.sh:69-74`, `scripts/yb_restart.sh:95-106`）。
  - `scripts/yb_collect.sh` は `approve/rework` 集計までで外部 CI 起動処理を持たない（`scripts/yb_collect.sh:1098-1111`, `scripts/yb_collect.sh:1278-1282`）。
- **期待効果**: approve 後の自動マージ・自動デプロイを実現し、品質ゲートを CI 必須チェックへ統合できる。
- **security**:
  - 認可主体: GitHub Actions は最小権限（既定 `contents:read`）、自動マージ job のみ `pull-requests:write`、デプロイは環境保護承認者に限定。
  - 入力検証: トリガー対象を `queue/reports/*_report.yaml` と保護ブランチに限定し、`review_result == approve` と schema 検証を両方満たした時のみ進行。
  - 秘密情報保管: デプロイ鍵・token は GitHub Secrets/Environment Secrets のみ使用し、workflow 内は `::add-mask::` でログ露出を抑止。
- **failure policy**:
  - retry/backoff/timeout: flaky step は 2 回再試行（30s/90s backoff）、workflow 全体 timeout 20 分、deploy job timeout 15 分。
  - circuit break: デフォルトブランチで連続 3 run 失敗時に auto-merge を停止し、`manual-merge-required` ラベル付与へ切替。
  - 手動介入条件: SAST/依存脆弱性 High 以上、または同一原因で 3 回連続失敗時は release manager 承認まで停止。
- **observability**:
  - 構造化ログキー: `workflow`, `run_id`, `sha`, `report_task_id`, `gate_result`, `stage`, `attempt`, `duration_ms`, `error_code`。
  - 主要メトリクス: `yb_ci_gate_pass_rate`, `yb_ci_gate_duration_seconds`, `yb_auto_merge_latency_minutes`, `yb_deploy_success_total`。
  - トレース/相関ID: `run_id` を root に `cmd_id/task_id` を annotation 付与し、ローカル report と CI 実行を相互参照可能にする。
- **test strategy**:
  - 正常系（approve report で test→gate→merge→deploy 通過）、異常系（`rework`/schema 不正/権限不足で停止）、回帰（ローカル `yb collect` 無影響）を unit/integration/e2e で検証。
- **優先度**: High

#### C-7. タスク自動スケジューリング（DAGベース）
- **課題**: 依存関係は手動資料と静的検証に留まり、実行時に `depends_on` を解決して自動で配車する仕組みがない。
- **提案内容**: `yb dispatch` に DAG スケジューラを実装し、`tasks.yaml` の依存グラフから「依存解決済みタスクのみ」を ready queue 化して空き worker へ自動割当する。完了時に後続ノードを自動解放する。
- **根拠**:
  - `docs/plans/dependency-map.md` は依存チェーン/フェーズを人手運用向けに整理した文書（`docs/plans/dependency-map.md:3`, `docs/plans/dependency-map.md:7-9`, `docs/plans/dependency-map.md:126-173`）。
  - `.yamibaito/plan/tasks.yaml` には `depends_on` が定義済み（`.yamibaito/plan/tasks.yaml:14`）。
  - `scripts/yb_dispatch.sh` は `task_id` と `status` だけを読んで `assigned|in_progress` を実行する実装で依存解決がない（`scripts/yb_dispatch.sh:71-91`）。
  - `depends_on`/DAG は `scripts/yb_plan_validate.py` の検証ロジックでのみ参照される（`scripts/yb_plan_validate.py:275`, `scripts/yb_plan_validate.py:334-339`, `scripts/yb_plan_validate.py:379-391`）。
- **期待効果**: Phase分割の運用を自動化し、依存未解決タスクの誤実行防止と worker 稼働率の向上を両立できる。
- **security**:
  - 認可主体: scheduler は queue 状態更新のみ可能、worker は自身に割当済み `task_id` のみ遷移可能、director が DAG 更新権限を保持。
  - 入力検証: `task_id` 形式検証、`depends_on` 実在確認、自己依存/循環依存を拒否し、ノード上限（例: 1000）超過時は計画読み込みを停止。
  - 秘密情報保管: DAG 実行自体は追加 secret を持たず、必要 token は既存環境変数境界を継承し scheduler ログへ出力しない。
- **failure policy**:
  - retry/backoff/timeout: ready queue 更新トランザクションは 4 回再試行、指数 backoff（1s/2s/4s/8s）、lock 取得 timeout 10s。
  - circuit break: lock timeout 5 分で 20 回超、または循環依存エラー 10 件超で auto-scheduling を一時停止。
  - 手動介入条件: circuit open 時、または orphan（依存解決不能）タスクが 5 件超で planner が DAG 定義を修正する。
- **observability**:
  - 構造化ログキー: `event`, `plan_id`, `task_id`, `depends_on`, `ready_queue_size`, `blocked_count`, `attempt`, `result`, `error_code`。
  - 主要メトリクス: `yb_scheduler_ready_queue_size`, `yb_scheduler_dispatch_lag_seconds`, `yb_scheduler_blocked_tasks_total`, `yb_scheduler_circuit_open_total`。
  - トレース/相関ID: `plan_id:task_id` を scheduler/worker 共通の相関キーとし、dispatch から完了報告まで一貫追跡する。
- **test strategy**:
  - 正常系（トポロジカル順の配車）、異常系（循環/欠損依存・競合更新の安全停止）、回帰（依存なしタスクの FIFO 相当維持）を unit/integration/e2e で検証。
- **優先度**: High

#### C-8. ロールバック & git リカバリ自動化
- **課題**: rework 時の git 状態復帰は手動運用で、失敗時も「手動で確認」にフォールバックするため、復旧速度と安全性が担当者依存になっている。
- **提案内容**: `yb recover`（`--task <id> --mode soft|hard`）を追加し、タスク開始時スナップショット（tag/patch）から自動復旧できるようにする。`review_result: rework` で復旧候補を提示し、承認後に自動適用する。
- **根拠**:
  - `bin/yb` に rollback/recover サブコマンドがない（`bin/yb:11-21`, `bin/yb:28-68`）。
  - `scripts/yb_restart.sh` は `worktree remove`/`gtr rm` 失敗時に「手動で確認してください」と警告（`scripts/yb_restart.sh:98-107`）。
  - `scripts/yb_stop.sh` も `gtr rm` 失敗時に同様の手動フォールバック（`scripts/yb_stop.sh:85-87`）。
  - `.yamibaito/config.yaml` の `quality_gate` は `max_rework_loops` など判定設定のみで git 復旧方針がない（`.yamibaito/config.yaml:15-20`）。
  - `scripts/yb_collect.sh` の rework 処理も集計のみで git 操作を行わない（`scripts/yb_collect.sh:1098-1111`）。
- **期待効果**: rework 時の復旧を標準化して MTTR を短縮し、`reset/revert` 誤操作リスクを下げられる。
- **security**:
  - 認可主体: `--mode hard` は director/admin のみ実行可、worker は自身担当タスクに対する `--mode soft` のみ許可。
  - 入力検証: `task_id` は厳格な ID 形式に限定し、snapshot 参照は `.yamibaito/snapshots/` 配下 allowlist（tag/patch）以外を拒否。
  - 秘密情報保管: patch 生成前に secret scan を実施し、検出時は保存中止; git 操作ログでは環境変数値を常時マスクする。
- **failure policy**:
  - retry/backoff/timeout: `git apply`/`git reset` は最大 2 回再試行（3s 固定 backoff）、1 コマンド timeout 20s、recover 全体 timeout 5 分。
  - circuit break: 同一 `task_id` の hard recover 失敗が 2 回連続した時点で自動 recover を停止し read-only モード化。
  - 手動介入条件: conflict 未解消、snapshot 欠損、または secret scan 失敗時は maintainer が手動復旧手順へ移行する。
- **observability**:
  - 構造化ログキー: `event`, `task_id`, `mode`, `snapshot_id`, `git_head_before`, `git_head_after`, `attempt`, `duration_ms`, `result`, `error_code`。
  - 主要メトリクス: `yb_recover_success_total`, `yb_recover_failure_total`, `yb_recover_duration_ms`, `yb_recover_manual_intervention_total`。
  - トレース/相関ID: `task_id` と `review_target_task_id` を共通相関キーにし、rework 判定から recover 実行まで連結追跡する。
- **test strategy**:
  - 正常系（`soft`/`hard` で期待状態へ復旧）、異常系（snapshot 欠損/権限不足/競合差分で circuit break）、回帰（`yb restart/stop` 継続利用）を unit/integration/e2e で検証。
- **優先度**: Medium
